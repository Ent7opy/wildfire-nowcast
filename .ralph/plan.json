{
  "version": 1,
  "goal_summary": "Improve wildfire detection quality by replacing naive FIRMS confidence filtering with a composite Fire Likelihood Score that combines FIRMS confidence (weak prior), persistence filtering, land-cover plausibility, weather plausibility, and industrial false-source masking. Fix UI bugs (tooltip, details panel, coordinate extraction) and update UI to reflect new likelihood semantics.",
  "tasks": [
    {
      "id": "WN-FIRE-001",
      "title": "Reinterpret FIRMS confidence as weak prior",
      "priority": "P0",
      "depends_on": [],
      "description": "Add `confidence_score` column to `fire_detections` table via migration. Implement sensor-specific normalization in api/fires/service.py (MODIS: 0-100%, VIIRS: nominal/low/high → numeric). Document sensor differences in docstring. Confidence contributes max 20% to final likelihood.",
      "files_likely": [
        "api/migrations/versions/YYYYMMDD_add_fire_likelihood_columns.py",
        "api/fires/service.py",
        "api/fires/repo.py"
      ],
      "acceptance": [
        "confidence_score column exists in fire_detections",
        "Normalization function handles MODIS and VIIRS formats",
        "Docstring explains sensor-specific confidence semantics"
      ],
      "verification": [
        "Would run: make migrate",
        "Would run: cd api && uv run python -c 'from api.fires.service import normalize_confidence; print(normalize_confidence(\"high\", \"VIIRS\"))'",
        "Would run: cd api && uv run pytest tests/test_fires_endpoint.py -v"
      ]
    },
    {
      "id": "WN-FIRE-002",
      "title": "Implement persistence filtering",
      "priority": "P0",
      "depends_on": [],
      "description": "Add `persistence_score` column via same migration as WN-FIRE-001. Create api/fires/scoring.py with function compute_persistence_scores(detections) that groups by ST_DWithin(geom, 750m) and time window (24-72h). Return dict[detection_id, score]. Multi-sensor bonus: +0.1 if ≥2 sensors. Single isolated detection: score ≤0.2.",
      "files_likely": [
        "api/fires/scoring.py",
        "api/fires/repo.py"
      ],
      "acceptance": [
        "compute_persistence_scores() groups spatially and temporally",
        "Multi-sensor detections get bonus",
        "Isolated detections penalized (score ≤0.2)"
      ],
      "verification": [
        "Would run: cd api && uv run pytest tests/test_fire_persistence_scoring.py -v"
      ]
    },
    {
      "id": "WN-FIRE-003",
      "title": "Add land-cover plausibility scoring",
      "priority": "P1",
      "depends_on": [],
      "description": "Add `landcover_score` column via same migration. Integrate land-cover dataset (suggest ESA WorldCover 10m global, or MODIS LC at 500m). Add api/fires/landcover.py with function compute_landcover_scores(detections) that queries land-cover type at each point. Scoring rules: forest/shrub/grass=1.0, cropland=0.7, urban/water/desert/ice=0.1.",
      "files_likely": [
        "api/fires/landcover.py",
        "api/fires/repo.py",
        "data/landcover.tif"
      ],
      "acceptance": [
        "Land-cover dataset ingested or accessible",
        "compute_landcover_scores() queries land-cover type per detection",
        "Urban and desert detections penalized"
      ],
      "verification": [
        "Would run: cd api && uv run pytest tests/test_fire_landcover_scoring.py -v",
        "Would run: cd api && uv run python -c 'from api.fires.landcover import compute_landcover_scores; print(compute_landcover_scores.__doc__)'"
      ]
    },
    {
      "id": "WN-FIRE-004",
      "title": "Integrate weather plausibility checks",
      "priority": "P1",
      "depends_on": [],
      "description": "Add `weather_score` column via same migration. In api/fires/scoring.py add compute_weather_scores(detections, weather_runs) that queries weather data (RH, precipitation, wind) for each detection location+time. Rules: RH>70%: score=0.3, recent precip (48h, >10mm): score=0.4, low RH + moderate wind: score=1.0. Reuse existing weather ingestion from api/routes/forecast.py patterns.",
      "files_likely": [
        "api/fires/scoring.py",
        "api/fires/repo.py"
      ],
      "acceptance": [
        "compute_weather_scores() queries weather data spatially and temporally",
        "High RH penalizes score",
        "Recent precipitation penalizes score",
        "Low RH + wind boosts score"
      ],
      "verification": [
        "Would run: cd api && uv run pytest tests/test_fire_weather_scoring.py -v"
      ]
    },
    {
      "id": "WN-FIRE-005",
      "title": "Add known false-source masking",
      "priority": "P1",
      "depends_on": [],
      "description": "Add `false_source_masked` boolean column via same migration. Repo already has industrial_sources table (api/migrations/versions/4757a7deda9f_add_fire_labels_and_industrial_sources.py). In api/fires/scoring.py add mask_false_sources(detections) that does ST_DWithin(fire.geom, industrial_sources.geom, 500m) query. Masked detections get final likelihood=0.0.",
      "files_likely": [
        "api/fires/scoring.py",
        "api/fires/repo.py"
      ],
      "acceptance": [
        "mask_false_sources() queries industrial_sources table spatially",
        "Detections within 500m of industrial sources masked",
        "Masked detections excluded from default UI view"
      ],
      "verification": [
        "Would run: cd api && uv run pytest tests/test_fire_false_source_masking.py -v",
        "Would run: psql -c 'SELECT COUNT(*) FROM fire_detections WHERE false_source_masked = TRUE;'"
      ]
    },
    {
      "id": "WN-FIRE-006",
      "title": "Compute composite Fire Likelihood Score",
      "priority": "P0",
      "depends_on": [
        "WN-FIRE-001",
        "WN-FIRE-002",
        "WN-FIRE-003",
        "WN-FIRE-004",
        "WN-FIRE-005"
      ],
      "description": "Add `fire_likelihood` float column via same migration. In api/fires/scoring.py create compute_fire_likelihood(detection) that combines: confidence_score*0.2 + persistence_score*0.3 + landcover_score*0.2 + weather_score*0.2 + multi_sensor_bonus*0.1. Update api/fires/repo.py to filter by fire_likelihood instead of raw confidence. Default threshold: ≥0.3 (uncertain), ≥0.6 (likely real).",
      "files_likely": [
        "api/fires/scoring.py",
        "api/fires/repo.py",
        "api/routes/fires.py"
      ],
      "acceptance": [
        "fire_likelihood column exists and populated",
        "API filters by fire_likelihood with default min_likelihood=0.3",
        "Weights sum to 1.0",
        "Global map shows plausible fire distribution (no continuous belts)"
      ],
      "verification": [
        "Would run: cd api && uv run pytest tests/test_fire_composite_likelihood.py -v",
        "Would run: psql -c 'SELECT MIN(fire_likelihood), MAX(fire_likelihood), AVG(fire_likelihood) FROM fire_detections WHERE fire_likelihood IS NOT NULL;'",
        "Would run: make lint"
      ]
    },
    {
      "id": "WN-FIRE-007",
      "title": "Update UI to reflect fire likelihood semantics",
      "priority": "P0",
      "depends_on": [
        "WN-FIRE-006"
      ],
      "description": "In ui/components/sidebar.py, rename 'Minimum confidence' slider to 'Fire likelihood threshold'. Change slider range to 0.0-1.0 (default 0.3). Add st.info tooltip: 'Composite score combining FIRMS confidence, persistence, land-cover, weather, and false-source filtering.' Update API call in ui/services/api.py to use min_likelihood param instead of min_confidence.",
      "files_likely": [
        "ui/components/sidebar.py",
        "ui/services/api.py"
      ],
      "acceptance": [
        "Slider labeled 'Fire likelihood threshold'",
        "Tooltip explains composite score",
        "API calls use min_likelihood parameter",
        "No mention of 'confidence' implying real fire probability"
      ],
      "verification": [
        "Would run: make dev-ui (manual inspection)",
        "Would run: cd ui && uv run pytest tests/test_app_imports.py"
      ]
    },
    {
      "id": "WN-FIRE-008",
      "title": "Fix map tooltip template rendering for confidence",
      "priority": "P1",
      "depends_on": [],
      "description": "In ui/components/map_view.py line 150-156, tooltip uses string interpolation with {confidence}. MVT layer properties may use different key name. Check api/migrations/versions/d46889070598_update_mvt_fires_props.py for property names. Fix tooltip dict to use correct property keys from MVT layer (likely 'confidence' not 'conf'). Test by inspecting MVT tile response from /tiles/fires/{z}/{x}/{y}.pbf.",
      "files_likely": [
        "ui/components/map_view.py",
        "api/routes/tiles.py"
      ],
      "acceptance": [
        "Tooltip shows numeric confidence value (not '{confidence}' placeholder)",
        "Tooltip property keys match MVT layer properties",
        "No JavaScript console errors about undefined properties"
      ],
      "verification": [
        "Would run: curl 'http://localhost:8000/tiles/fires/5/17/11.pbf?start_time=2026-01-18T00:00:00Z&end_time=2026-01-19T23:59:59Z' | xxd | head",
        "Would run: make dev-ui (manual click test)"
      ]
    },
    {
      "id": "WN-FIRE-009",
      "title": "Fix selected fire details panel data mapping",
      "priority": "P1",
      "depends_on": [],
      "description": "In ui/components/click_details.py line 36-59, st.session_state.selected_fire is set by map_view.py line 177. Inspect MVT properties schema to ensure all required fields (id, acq_time, sensor, confidence, frp, source, lat, lon) are included in MVT layer. Update api/routes/tiles.py MVT query if needed to expose missing columns. Fix property key names in click_details.py to match MVT schema.",
      "files_likely": [
        "ui/components/click_details.py",
        "ui/components/map_view.py",
        "api/routes/tiles.py"
      ],
      "acceptance": [
        "Clicking fire point populates all detail fields (no None values for present data)",
        "MVT layer includes all required properties",
        "Property key names match between MVT and UI"
      ],
      "verification": [
        "Would run: make dev-ui (manual click test)",
        "Would run: cd api && uv run pytest tests/test_tiles_endpoint.py -v"
      ]
    },
    {
      "id": "WN-FIRE-010",
      "title": "Fix forecast failure due to missing/incorrect coordinates in selected fire",
      "priority": "P0",
      "depends_on": [
        "WN-FIRE-009"
      ],
      "description": "In ui/components/click_details.py line 86-95, forecast_bbox is constructed from lat/lon. Trace coordinate extraction: MVT features use GeoJSON Point geometry (geometry.coordinates = [lon, lat]). Update map_view.py line 179 to extract coordinates from geometry if properties.lat/lon are missing. Add validation in click_details.py: check lat ∈ [-90,90], lon ∈ [-180,180]. Log payload on failure for debugging.",
      "files_likely": [
        "ui/components/click_details.py",
        "ui/components/map_view.py"
      ],
      "acceptance": [
        "Forecast generation succeeds for all valid fire detections",
        "No 'missing coordinates' error for valid detections",
        "Coordinates validated before API call",
        "Failure cases logged with payload details"
      ],
      "verification": [
        "Would run: make dev-ui (manual click + forecast test)",
        "Would run: cd ui && uv run pytest tests/test_app_imports.py"
      ]
    },
    {
      "id": "WN-FIRE-011",
      "title": "Add contract test for fire map feature properties used by UI",
      "priority": "P2",
      "depends_on": [
        "WN-FIRE-008",
        "WN-FIRE-009",
        "WN-FIRE-010"
      ],
      "description": "Create api/tests/test_fire_map_contract.py that validates MVT layer properties schema. Test fetches /tiles/fires/{z}/{x}/{y}.pbf, decodes MVT, and asserts required properties exist: id, acq_time, lat, lon, sensor, source, confidence, frp, fire_likelihood. Add ui/tests/test_fire_details_contract.py that mocks selected_fire and validates click_details.py can render all fields without KeyError.",
      "files_likely": [
        "api/tests/test_fire_map_contract.py",
        "ui/tests/test_fire_details_contract.py"
      ],
      "acceptance": [
        "Test fails if MVT properties missing required fields",
        "Test fails if UI mapping breaks (KeyError, AttributeError)",
        "Tests run in CI via make test"
      ],
      "verification": [
        "Would run: cd api && uv run pytest tests/test_fire_map_contract.py -v",
        "Would run: cd ui && uv run pytest tests/test_fire_details_contract.py -v",
        "Would run: make test"
      ]
    }
  ]
}
