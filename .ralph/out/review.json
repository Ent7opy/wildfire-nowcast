{
  "task_id": "T01",
  "verdict": "changes_requested",
  "requested_changes": [
    {
      "severity": "must",
      "title": "Integration tests fail due to missing database migrations",
      "evidence": "api/tests/test_fire_likelihood_integration.py::test_composite_likelihood_pipeline - Failed with: psycopg2.errors.UndefinedColumn: column \"false_source_masked\" of relation \"fire_detections\" does not exist",
      "suggested_fix": "The test database needs to have migrations applied before running integration tests. Run 'make migrate' or document that integration tests require a migrated database with the new schema columns (persistence_score, landcover_score, weather_score, false_source_masked, fire_likelihood). Consider adding a pytest fixture or CI step that ensures migrations are applied before running integration tests, or mark these tests to skip if schema is not migrated."
    }
  ],
  "verification": [
    "Ran: uv run pytest tests/test_fire_likelihood_scoring.py -v (10 passed)",
    "Ran: uv run pytest tests/test_fire_persistence_scoring.py -v (6 passed)",
    "Ran: uv run pytest tests/test_fire_map_contract.py -v (5 passed)",
    "Ran: uv run pytest tests/test_fire_details_contract.py -v (4 passed, in ui/)",
    "Ran: uv run pytest tests/test_fire_likelihood_integration.py::test_composite_likelihood_pipeline -v (1 failed due to missing migrations)",
    "Reviewed: git diff --stat (29 files changed, 537 insertions, 250 deletions)",
    "Reviewed: All 7 new migration files have correct dependency chain",
    "Reviewed: API routes, scoring logic, repo functions, UI components, ingest pipeline integration"
  ],
  "notes": [
    "GOAL COVERAGE: The implementation comprehensively addresses the stated goal - composite Fire Likelihood Score replaces naive FIRMS confidence filtering with proper weighting (confidence 0.2, persistence 0.3, landcover 0.25, weather 0.25), industrial false-source masking returns 0.0 likelihood, and UI bugs are fixed (tooltip shows fire_likelihood, details panel shows all component scores, coordinate extraction logging added).",
    "UNIT TESTS PASS: All unit tests for likelihood scoring (10 tests), persistence scoring (6 tests), map contract (5 tests), and UI contract (4 tests) pass successfully. The scoring logic is well-tested with edge cases covered.",
    "MIGRATION CHAIN CORRECT: The 7 new migrations follow a linear dependency chain from b8e90cee90c8 → persistence_score → landcover_score → weather_score → false_source_masked → fire_likelihood → update_mvt_fires_likelihood → add_mvt_fires_likelihood_filter. Each migration properly declares down_revision.",
    "PERSISTENCE TIME WINDOW CHANGE: Changed from (24.0, 72.0) to (0.0, 72.0) hours. This is semantically correct - the SQL query looks BACKWARD from target detection time, so (0, 72) means 'look back 0-72 hours' which includes the target detection at time 0. This strengthens persistence scoring by including recent co-located detections as strong positive signals.",
    "RESOURCE CLEANUP FIX: Added proper finally block for xarray dataset cleanup in _get_weather_data_for_point() to prevent resource leaks (api/fires/scoring.py:515).",
    "API BACKWARD COMPATIBILITY: min_confidence parameter retained (deprecated) alongside new min_fire_likelihood parameter in routes/fires.py. Both parameters coexist, allowing gradual client migration.",
    "UI SEMANTIC SHIFT: Sidebar changed from 'Minimum confidence (0-100)' to 'Minimum fire likelihood (0-1)' with helpful tooltip explaining composite score. Map tooltip changed from showing FIRMS confidence to showing fire_likelihood. This is a significant UX change but aligns with goal.",
    "NULL HANDLING: compute_fire_likelihood() properly handles None values by defaulting to 0.5 for optional scores (persistence, landcover, weather). confidence_score defaults to 0.5 if NULL in update_fire_likelihood(). This is defensive and reasonable.",
    "LANDCOVER FILE GRACEFUL DEGRADATION: Missing landcover.tif file results in warning log and neutral scores (0.5) rather than failure, which is appropriate for optional enhancement (api/fires/landcover.py:95-100).",
    "DEPENDENCY ADDED: xarray>=2023.0.0,<2025.0.0 added to api/pyproject.toml (needed for weather data processing in scoring.py).",
    "INGEST PIPELINE INTEGRATION: firms_ingest.py properly orchestrates all scoring steps after detection insertion: false_source_masking → persistence_scores → landcover_scores → weather_scores → fire_likelihood (ingest/firms_ingest.py:105-109). Each step wrapped in try/except with logging."
  ]
}
